{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å —ç–∫—Å–ø–µ—Ä—Ç–∞ - –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è AI-–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2 class="text-white">
            <i class="bi bi-award"></i> –ü–∞–Ω–µ–ª—å —ç–∫—Å–ø–µ—Ä—Ç–∞
        </h2>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-clock-history text-warning" style="font-size: 3rem;"></i>
                <h3 class="mt-2">{{ stats.unverified_count }}</h3>
                <p class="text-muted mb-0">–¢—Ä–µ–±—É–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-book-fill text-primary" style="font-size: 3rem;"></i>
                <h3 class="mt-2">{{ stats.knowledge_count }}</h3>
                <p class="text-muted mb-0">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                <h3 class="mt-2">{{ stats.verified_today }}</h3>
                <p class="text-muted mb-0">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</p>
            </div>
        </div>
    </div>
</div>

<!-- –ù–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-check"></i> –¢—Ä–µ–±—É–µ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
                </h5>
            </div>
            <div class="card-body">
                {% if unverified_messages %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th>–ü–æ–º–æ—â–Ω–∏–∫</th>
                                <th>–í–æ–ø—Ä–æ—Å</th>
                                <th>–û—Ç–≤–µ—Ç</th>
                                <th>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for msg in unverified_messages %}
                            <tr>
                                <td>{{ msg.id }}</td>
                                <td>
                                    <small class="text-muted">{{ msg.created_at }}</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar me-2" style="background-color: {{ msg.user_color }}; width: 30px; height: 30px; font-size: 0.9rem;">
                                            {{ msg.user_name[0].upper() }}
                                        </div>
                                        <small>{{ msg.user_name }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span style="font-size: 1.5rem;">{{ msg.assistant_icon }}</span>
                                    <br><small>{{ msg.assistant_name }}</small>
                                </td>
                                <td>
                                    <div class="text-truncate" style="max-width: 200px;" title="{{ msg.message }}">
                                        {{ msg.message }}
                                    </div>
                                </td>
                                <td>
                                    <div class="text-truncate" style="max-width: 250px;" title="{{ msg.response }}">
                                        {{ msg.response[:100] }}...
                                    </div>
                                </td>
                                <td>
                                    {% set confidence = (msg.confidence * 100)|int %}
                                    {% if confidence >= 70 %}
                                        <span class="badge bg-success">{{ confidence }}%</span>
                                    {% elif confidence >= 50 %}
                                        <span class="badge bg-warning text-dark">{{ confidence }}%</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ confidence }}%</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showVerifyModal({{ msg.id }}, '{{ msg.message }}', '{{ msg.response }}')">
                                        <i class="bi bi-check-square"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                    <p class="text-muted mt-3">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-book"></i> –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
                </h5>
                <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addKnowledgeModal">
                    <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
                </button>
            </div>
            <div class="card-body">
                {% if knowledge_items %}
                <div class="row">
                    {% for item in knowledge_items %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">
                                        <span class="me-2" style="font-size: 1.5rem;">{{ item.icon }}</span>
                                        {{ item.title }}
                                    </h6>
                                    {% if item.is_verified %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">–û–∂–∏–¥–∞–µ—Ç</span>
                                    {% endif %}
                                </div>
                                <p class="card-text text-muted small">
                                    {{ item.content[:150] }}{% if item.content|length > 150 %}...{% endif %}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-primary">{{ item.category }}</span>
                                    <small class="text-muted">
                                        {% if item.uploader_name %}
                                            –æ—Ç {{ item.uploader_name }}
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                    <p class="text-muted mt-3">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø—É—Å—Ç–∞</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
<div class="modal fade" id="verifyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-square"></i> –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è #<span id="verify-msg-id"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="verifyForm">
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="text-primary">
                            <i class="bi bi-question-circle"></i> –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
                        </h6>
                        <div class="p-3 bg-light rounded" id="verify-question"></div>
                    </div>
                    <div class="mb-4">
                        <h6 class="text-success">
                            <i class="bi bi-chat-left-quote"></i> –û—Ç–≤–µ—Ç —Å–∏—Å—Ç–µ–º—ã:
                        </h6>
                        <div class="p-3 bg-light rounded" id="verify-response" style="white-space: pre-line;"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–∞</label>
                        <textarea class="form-control" name="notes" rows="3" 
                                  placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" name="action" value="reject" class="btn btn-warning">
                        <i class="bi bi-x-circle"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                    </button>
                    <button type="submit" name="action" value="approve" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> –û–¥–æ–±—Ä–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
<div class="modal fade" id="addKnowledgeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-book"></i> –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/expert/knowledge/add">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                        <textarea class="form-control" name="content" rows="6" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="form-select" name="category" required>
                            <option value="–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ_–ø—Ä–∞–≤–æ">–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ –ø—Ä–∞–≤–æ</option>
                            <option value="—Ç—Ä—É–¥–æ–≤–æ–µ_–ø—Ä–∞–≤–æ">–¢—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ</option>
                            <option value="—Å–µ–º–µ–π–Ω–æ–µ_–ø—Ä–∞–≤–æ">–°–µ–º–µ–π–Ω–æ–µ –ø—Ä–∞–≤–æ</option>
                            <option value="–Ω–∞–ª–æ–≥–æ–≤–æ–µ_–ø—Ä–∞–≤–æ">–ù–∞–ª–æ–≥–æ–≤–æ–µ –ø—Ä–∞–≤–æ</option>
                            <option value="—É–≥–æ–ª–æ–≤–Ω–æ–µ_–ø—Ä–∞–≤–æ">–£–≥–æ–ª–æ–≤–Ω–æ–µ –ø—Ä–∞–≤–æ</option>
                            <option value="–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ_–ø—Ä–∞–≤–æ">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                        <input type="text" class="form-control" name="source" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–ö –†–§, —Å—Ç–∞—Ç—å—è 123">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ò–∫–æ–Ω–∫–∞ (emoji)</label>
                        <input type="text" class="form-control" name="icon" value="üìö">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showVerifyModal(id, question, response) {
        document.getElementById('verify-msg-id').textContent = id;
        document.getElementById('verify-question').textContent = question;
        document.getElementById('verify-response').textContent = response;
        document.getElementById('verifyForm').action = `/expert/message/${id}/verify`;
        
        const modal = new bootstrap.Modal(document.getElementById('verifyModal'));
        modal.show();
    }
</script>
{% endblock %}